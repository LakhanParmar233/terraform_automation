 pipeline {
    agent any
    parameters {
        string(name: 'REGION', description: 'Terraform region variable')
        string(name: 'INSTANCE_TYPE', description: 'Terraform instance_type variable')
        string(name: 'TAG_NAME', description: 'Terraform tag_name variable')
        string(name: 'AMI_ID', description: 'Terraform ami_id variable')
        booleanParam(name: "ACTION", defaultValue: false)
    }
    stages {
        stage('init') {
            steps {
                sh ('terraform init') 
            }
        }
        stage('Modify terraform.tfvars') {
            steps {
                script {
                    def terraformVarsFile = "${WORKSPACE}/terraform.tfvars"

                    // Read the content of terraform.tfvars
                    def terraformVarsContent = readFile(terraformVarsFile)

                    // Replace variables with Jenkins parameters
                    terraformVarsContent = terraformVarsContent.replaceAll(/region = ".+"/, "region = \"${params.REGION}\"")
                    terraformVarsContent = terraformVarsContent.replaceAll(/instance_type = ".+"/, "instance_type = \"${params.INSTANCE_TYPE}\"")
                    terraformVarsContent = terraformVarsContent.replaceAll(/tag_name = ".+"/, "tag_name = \"${params.TAG_NAME}\"")
                    terraformVarsContent = terraformVarsContent.replaceAll(/ami_id = ".+"/, "ami_id = \"${params.AMI_ID}\"")

                    // Write the modified content back to terraform.tfvars
                    writeFile(file: terraformVarsFile, text: terraformVarsContent)
                }
            }
        }
        stage('terraform  action') {
            steps {
              script{
               if(params.ACTION){
                  echo "Terraform action is --> ${action}"
                  sh ('terraform ${action} --auto-approve')
               }else{
                  echo "Terraform action is --> ${action}"
                  sh ('terraform ${action}')}
              }

            }
        }
    }
    
}
